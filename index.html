
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sintha Helping Hand</title>
    
    <!-- Google Font for a professional look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome 6.5.1 CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- GLASSMORPHISM THEME & LAYOUT REDESIGN --- */
        
        /* --- 1. Variables & General Styling --- */
        :root {
            --primary-color: #185a9d;
            --secondary-color: #ffeb3b;
            --dark-bg-gradient: linear-gradient(145deg, #42cea2 0%, #185a9d 50%);
            
            --text-primary-light: #ffffff;
            --text-secondary-light: #ffffff;
            
            --success-color: #ffffff;
            --pending-color: orange;
            --loss-color: #ffffff; 
            --reject-color: #ffffff;
            --win-example-color: #90ee90; /* Light green for example */

            /* Glassmorphism Variables */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-bg-hover: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(10, 0, 30, 0.37);
            --glass-blur: 1px;
            --glass-radius: 16px;
            
            --glow-color: rgba(255, 235, 59, 0.8);
            --spin-duration: 5s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        html { scroll-behavior: smooth; }

        body {
            background: var(--dark-bg-gradient);
            color: var(--text-primary-light);
            padding-bottom: 75px; /* Space for bottom nav */
            min-height: 100vh;
            overflow-x: hidden; /* Prevent blobs from causing scroll */
            position: relative;
        }
        
        /* Decorative background blobs */
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            filter: blur(120px);
            z-index: -1;
            opacity: 0.7;
        }
        body::before {
            width: 350px;
            height: 350px;
            background: rgba(255, 235, 59, 0.15);
            top: -100px;
            left: -150px;
        }
        body::after {
            width: 450px;
            height: 450px;
            background: rgba(156, 39, 176, 0.2);
            bottom: -150px;
            right: -150px;
        }

        .container {
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page { display: none; }
        .page.active { display: block; }

        h1, h2, h3, h4 { color: var(--text-primary-light); margin-bottom: 0.5rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); text-align: center; }
        h1 { font-size: 1.6rem; }
        h2 { font-size: 1.3rem; }
        
        /* --- 2. Buttons, Inputs & Forms (Glassmorphism Style) --- */
        button, .btn {
            padding: 8px 14px; border: 1px solid var(--glass-border); border-radius: 8px; cursor: pointer;
            font-size: 0.85rem; font-weight: 600; transition: all 0.25s ease-in-out; text-align: center;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary-light);
        }
        button:hover:not(:disabled), .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }
        button:disabled { background-color: rgba(100,100,100,0.2); border-color: rgba(100,100,100,0.3); color: #aaa; cursor: not-allowed; box-shadow: none; transform: none; }

        .btn-primary { background: var(--primary-color); border-color: var(--primary-color); }
        .btn-secondary { background: var(--secondary-color); border-color: var(--secondary-color); color: #333; }
        .btn-danger { background: var(--loss-color); border-color: var(--loss-color); }
        
        .btn-icon {
            background: none; padding: 5px 8px; font-size: 1rem; box-shadow: none; color: var(--text-secondary-light); border: none;
        }
        .btn-icon:hover { background-color: rgba(255,255,255,0.1); transform: scale(1); }
        .btn-icon.edit { color: var(--primary-color); }
        .btn-icon.delete { color: red }
        .btn-icon.book { color: green }
        .btn-icon-accept { color: green}
        .btn-icon-reject { color: red }
       
        input, select, textarea {
            width: 100%; padding: 8px; margin-bottom: 1rem;
            border-radius: 8px; font-size: 0.85rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-primary-light);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input::placeholder, textarea::placeholder { color: var(--text-secondary-light); }
        select option { background: #333; }

        input[type="file"] {
            padding: 4px;
        }
        input[type="file"]::-webkit-file-upload-button {
             background: var(--primary-color);
             border: none;
             padding: 5px 8px;
             border-radius: 6px;
             color: white;
             cursor: pointer;
             margin-right: 10px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(24, 90, 157, 0.5);
        }
        
        .search-container { position: relative; margin: 20px 0; }
        .search-container .fa-search {
            position: absolute; left: 15px; top: 40%;
            transform: translateY(-50%); color: var(--text-secondary-light);
        }
        .search-container input { padding-left: 40px; }

        /* --- 3. Card & List Styles (Glassmorphism Style) --- */
        .lottery-card {
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: var(--glass-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            margin-bottom: 20px; overflow: hidden;
            transition: transform 0.2s, background 0.2s;
        }
        .lottery-card:hover {
             transform: translateY(-5px);
             background: var(--glass-bg-hover);
        }
        .lottery-card[onclick] { cursor: pointer; }
        
        .lottery-card img { 
            width: 100%; 
            height: auto; 
            display: block;
        }
        .lottery-card-content { padding: 15px; }
        .lottery-card-content h3 { margin-top: 0; margin-bottom: 8px; font-size: 1.1rem; text-align: center; }
        .lottery-card-content p { color: var(--text-secondary-light); font-size: 0.8rem; margin-bottom: 8px; }
        .lottery-card-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .lottery-card-buttons button { flex-grow: 1; }

        /* --- 4. Table Styles (Glassmorphism Style) --- */
        .table-wrapper { 
            overflow-x: auto; 
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            border-radius: var(--glass-radius);
            padding: 10px;
            margin: 20px 0;
            box-shadow: var(--glass-shadow);
        }
        table {
            width: 100%; border-collapse: collapse;
        }
        th, td {
            padding: 10px 6px; text-align: left;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-secondary-light);
            font-size: 0.8rem;
        }
        th { 
            background-color: rgba(255,255,255,0.1); 
            color: var(--text-primary-light); 
            font-weight: 600; font-size: 0.75rem; text-transform: uppercase;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: rgba(255,255,255,0.08); }
        .status-win, .status-confirmed { color: var(--success-color); font-weight: 600; }
        .status-loss { color: var(--loss-color); font-weight: 600; }
        .status-pending { color: var(--pending-color); font-weight: 600; }
        .status-rejected { color: var(--reject-color); font-weight: 600; text-decoration: line-through; }
        .ticket-actions { white-space: nowrap; }
        .win-example {
            color: var(--win-example-color);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* --- 5. Modal Styling (Glassmorphism Style) --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; 
            background-color: rgba(10, 0, 30, 0.4);
            justify-content: center; align-items: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            margin: auto; padding: 20px;
            width: 90%; max-width: 500px; border-radius: var(--glass-radius); position: relative;
            max-height: 90vh; /* Added for scrollability on small screens */
            overflow-y: auto; /* Added for scrollability */
        }
        .close-btn {
            color: #ccc; position: absolute; top: 10px; right: 20px;
            font-size: 28px; font-weight: bold; cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover { color: #fff; }

        /* --- 6. Bottom Navigation Bar (Glassmorphism Style) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex; justify-content: space-around;
            border-top: 1px solid var(--glass-border);
            z-index: 999;
        }
        .nav-btn {
            background: none; border: none; color: #bbb; display: flex; flex-direction: column;
            align-items: center; font-size: 0.7rem; cursor: pointer; transition: color 0.2s, transform 0.2s; 
            flex-grow: 1; height: 100%; justify-content: center;
        }
        .nav-btn.active { 
            color: var(--secondary-color); 
            font-weight: 600;
            transform: translateY(-3px);
        }
        .nav-btn:hover {
             color: var(--text-primary-light);
        }
        .nav-btn .fas { font-size: 20px; margin-bottom: 5px; }

        /* --- 7. Admin Dashboard & Reports (Glassmorphism Style) --- */
        #admin-dashboard-page .admin-nav {
            display: flex;
            flex-direction: column; /* Stack buttons on mobile */
            gap: 10px;
            margin-bottom: 20px;
        }
        #admin-dashboard-page .admin-nav .btn.active {
            background: var(--primary-color);
            color: var(--text-primary-light);
            box-shadow: 0 4px 15px rgba(24, 90, 157, 0.4);
            transform: translateY(-2px);
        }
        #admin-dashboard-page .admin-nav .btn:not(.active) {
            background: var(--glass-bg);
        }

        .admin-tab-content { display: none; }
        .admin-tab-content.active { display: block; }
        .manageable-lottery-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-radius: 12px; margin-bottom: 10px;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            transition: background-color 0.2s;
        }
        .manageable-lottery-item:hover { background-color: var(--glass-bg-hover); }
        .manageable-lottery-item-info { flex-grow: 1; cursor: pointer; padding-right: 10px; }
        .manageable-lottery-item-info strong { font-size: 0.9rem; }
        .manageable-lottery-item-info small { font-size: 0.7rem; }
        .manageable-lottery-item-actions { display: flex; align-items: center; }

        .report-lottery-item {
            background: var(--glass-bg); padding: 15px; border-radius: 12px; margin-bottom: 12px;
            border-left: 5px solid var(--primary-color); cursor: pointer;
            transition: all 0.2s ease;
        }
        .report-lottery-item:hover {
            transform: translateX(5px);
            background: var(--glass-bg-hover);
        }
        .report-stats { display: flex; justify-content: space-between; margin-top: 10px; flex-wrap: wrap; gap: 10px;}
        .report-stats span { font-weight: 600; }
        .report-stats .amount { color: var(--success-color); }

        /* --- 8. LIVE DRAW PAGE STYLES --- */
        .live-draw-container {
            background: radial-gradient(circle, #185a9d 0%, #1a2a45 100%);
            padding: 20px 15px; border-radius: var(--glass-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), inset 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid var(--secondary-color);
        }
        #live-status {
            text-align: center; font-size: 1.1rem; font-weight: bold;
            color: white; text-shadow: 2px 2px 4px black; margin-bottom: 20px;
            min-height: 1.2em;
        }
        #admin-controls {
            display: none;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 12px; margin-bottom: 10px;
        }
        .admin-controls-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .admin-controls-buttons button { flex-grow: 1; }
        .spinners-container {
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; margin-bottom: 30px;
        }
        .spinner-wrapper { text-align: center; }
        .spinner-wrapper h3 {
            color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            font-size: 1rem; margin-bottom: 15px;
        }
        
        .spinner-container {
            position: relative;
            width: min(75vw, 250px);
            height: min(75vw, 250px);
            margin: 0 auto;
        }

        /* --- NAME PICKER --- */
        #name-spinner-container {
            width: min(85vw, 350px);
            height: min(30vw, 120px);
            border-radius: var(--glass-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: #1a2a45;
            border: 5px solid var(--secondary-color);
            box-shadow: 0 0 20px var(--glow-color);
            overflow: hidden;
            transition: background 0.5s ease;
        }
        
        #name-spinner-container.is-cycling {
            background-size: 200% 200%;
            background-image: linear-gradient(45deg, #1a2a45, #185a9d, #1a2a45);
            animation: electric-bg 2s linear infinite;
        }

        @keyframes electric-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }


        #name-picker-display {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            text-align: center;
        }
        #name-picker-display span {
            font-size: 1.5rem; /* Adjusted for longer text */
            font-weight: 700;
            color: var(--secondary-color);
            text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color);
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            display: inline-block;
            word-break: break-word; /* Helps with long names */
        }
        #name-picker-display.picking span {
            opacity: 0.7;
            transform: scale(0.95);
        }
        #name-picker-display.picked span {
            transform: scale(1.1);
            animation: winner-glow 1s ease-in-out;
        }
        @keyframes winner-glow {
            0%, 100% { text-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color); }
            50% { text-shadow: 0 0 20px #fff, 0 0 30px #fff, 0 0 40px var(--secondary-color); }
        }
        @media (max-width: 400px) {
            #name-picker-display span { font-size: 1.2rem; } /* Adjusted for longer text */
        }

        /* --- [START] SLOT MACHINE STYLES --- */
        #slot-machine-container {
            width: min(85vw, 350px);
            height: min(30vw, 120px);
            border-radius: var(--glass-radius);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 10px;
            background: #1a2a45;
            border: 5px solid var(--secondary-color);
            box-shadow: 0 0 20px var(--glow-color), inset 0 0 15px rgba(0,0,0,0.6);
            overflow: hidden;
            position: relative;
        }

        .slot-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border-radius: var(--glass-radius);
            background: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.1) 20%, transparent 50%, rgba(0,0,0,0.1) 80%, rgba(0,0,0,0.5) 100%);
            box-shadow: inset 0 5px 10px rgba(0,0,0,0.3), inset 0 -5px 10px rgba(0,0,0,0.3);
        }

        .slot-column {
            width: 30%;
            height: 100%;
            overflow: hidden;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .slot-reel {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .slot-symbol {
            width: 100%;
            height: min(30vw, 120px);
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-transform: uppercase;
        }
        .slot-symbol.win {
            color: green;
        }
        .slot-symbol.loss {
            color: red;
        }
        /* --- [END] SLOT MACHINE STYLES --- */


        @media (min-width: 768px) {
            .spinners-container { 
                flex-direction: row; 
                justify-content: space-around; 
                align-items: flex-start; 
            }
             #admin-dashboard-page .admin-nav {
                flex-direction: row;
                flex-wrap: wrap;
            }
            #logout-btn {
                margin-left: auto;
            }
        }

        /* --- 9. Status Popup --- */
        #status-popup {
            display: none; position: fixed; bottom: 80px; left: 50%;
            transform: translateX(-50%); color: white; padding: 15px 25px;
            border-radius: 8px; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            opacity: 0; transition: opacity 0.5s, transform 0.5s;
        }
        #status-popup.show {
            display: block; opacity: 1; transform: translateX(-50%) translateY(-10px);
        }
        
        /* --- 10. Loading Animation --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg-gradient);
            display: grid; 
            place-items: center; 
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            text-align: center; 
        }
        .loader-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .loader {
            width: 80px;
            height: 80px;
            border: 5px solid var(--glass-border);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            box-shadow: var(--glass-shadow);
        }
        .loader-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            color: var(--secondary-color);
            animation: pulse 2s infinite ease-in-out;
        }
        #loading-overlay p {
            position: absolute; 
            top: calc(50% + 60px); 
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.1rem;
            color: var(--text-primary-light);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* --- 11. LOGIN PAGE TABS --- */
        .login-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }
        .login-tab-button {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary-light);
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
        }
        .login-tab-button.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }
        .login-form-container { display: none; }
        .login-form-container.active { display: block; }
    </style>
</head>
<body>

    <!-- Audio elements for the live draw -->
    <audio id="name-picker-audio" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2b23547161.mp3" preload="auto" loop></audio>
    <audio id="slot-machine-audio" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_a17c2aa4a8.mp3" preload="auto"></audio>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader-wrapper">
            <div class="loader"></div>
            <i class="fas fa-hands-helping loader-icon"></i>
        </div>
        <p>Loading Sintha Helping Hand...</p>
    </div>


    <div id="app">

        <!-- HOME PAGE -->
        <div id="lottery-page" class="page active">
            <div class="container">
                <h1>Sintha Helping Hand</h1>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-bar" placeholder="Search for a lottery...">
                </div>
                <h2>Upcoming Draws</h2>
                <div id="lottery-list"></div>
            </div>
        </div>

        <!-- LIVE DRAW PAGE -->
        <div id="live-page" class="page">
            <div class="container">
                <div class="live-draw-container">
                    
                    <p id="live-status">Game not Start...</p>
                    
                    <div id="admin-controls">
                         <div class="admin-controls-buttons">
                             <button id="start-draw-btn" class="btn btn-primary">Start Auto-Draw</button>
                             <button id="reset-draw-btn" class="btn btn-secondary">Reset Lottery</button>
                         </div>
                    </div>

                    <div class="spinners-container">
                        <div class="spinner-wrapper">
                             <h3>Next Participant</h3>
                            <div id="name-spinner-container" class="spinner-container">
                                <div id="name-picker-display" data-last-pick-id="">
                                    <span>STARTING SOON</span>
                                </div>
                            </div>
                        </div>
                        <div class="spinner-wrapper">
                            <h3>Result</h3>
                            <!-- START: SLOT MACHINE HTML -->
                            <div id="slot-machine-container" class="spinner-container">
                                <div class="slot-column">
                                    <div class="slot-reel" id="reel1"></div>
                                </div>
                                <div class="slot-column">
                                    <div class="slot-reel" id="reel2"></div>
                                </div>
                                <div class="slot-column">
                                    <div class="slot-reel" id="reel3"></div>
                                </div>
                                <div class="slot-overlay"></div>
                            </div>
                            <!-- END: SLOT MACHINE HTML -->
                        </div>
                    </div>
                </div>

                <!-- [MODIFIED] Win Rule Text with English and Green Example -->
                <div class="lottery-card" style="padding: 15px; margin-top: 20px; text-align: center;">
                    <h4>How Winning is Decided</h4>
                    <p style="font-size: 0.85rem; line-height: 1.6;">
                        Our system automatically draws one participant at a time. The result ('WIN' or 'LOSS') for each participant is determined by a probability calculation based on the number of prizes remaining versus the number of participants left in the draw.
                        <br><br>
                        The slot machine visually displays this result. If all three columns show 'WIN', the participant is a <strong>Winner</strong>.
                        <br>
                        <strong class="win-example">Example: [ WIN ] [ WIN ] [ WIN ] = Winner!</strong>
                    </p>
                </div>

                <!-- Live Result Search -->
                <div class="search-container" style="margin-top: 30px;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="live-result-search" placeholder="Search your ticket by number or name...">
                </div>
                <div id="live-search-result-container" class="lottery-card" style="display: none; padding: 15px; text-align: center; margin-bottom: 20px;">
                    <!-- Search result appears here -->
                </div>

                <h3>üèÜ Winners List</h3>
                <div class="table-wrapper">
                    <table id="winners-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Prize</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h3>üéüÔ∏è All Other Tickets</h3>
                <div class="table-wrapper">
                     <table id="losers-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- HISTORY PAGE -->
        <div id="history-page" class="page">
            <div class="container">
                <h1>Lottery History</h1>
                <div id="lottery-history-list"></div>
            </div>
        </div>

        <!-- HISTORY DETAILS PAGE (Replaced by Modal, but kept for structure) -->
        <div id="lottery-details-page" class="page">
             <div class="container">
                <button onclick="showPage('history-page')" class="btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Back to History</button>
                <h1 id="details-lottery-title"></h1>
                <div class="lottery-card">
                    <img id="details-lottery-img" src="" alt="Lottery Image">
                    <div class="lottery-card-content">
                        <p><strong>Draw Date:</strong> <span id="details-lottery-datetime"></span></p>
                        <p id="details-lottery-desc"></p>
                    </div>
                </div>
                <h3>üèÜ Winners List</h3>
                <div class="table-wrapper">
                    <table id="details-winners-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Prize</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h3>üéüÔ∏è All Other Tickets</h3>
                <div class="table-wrapper">
                     <table id="details-losers-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PUBLIC TICKET LIST PAGE -->
        <div id="lottery-for-tickets-page" class="page">
             <div class="container">
                <h1>Select Lottery to View Tickets</h1>
                <div id="lottery-selection-list"></div>
            </div>
        </div>

        <!-- TICKET DETAILS PAGE (for public) -->
        <div id="ticket-details-for-lottery-page" class="page">
            <div class="container">
                <button onclick="showPage('lottery-for-tickets-page')" class="btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Back to Lotteries</button>
                <div id="ticket-lottery-details-container"></div>
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="public-ticket-search" placeholder="Search by Ticket No. or Name...">
                </div>
                <div class="table-wrapper">
                    <table id="public-lottery-ticket-table">
                        <thead><tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- LOGIN PAGE (Admin & User) -->
        <div id="login-page" class="page">
             <div class="container" style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
                <div class="lottery-card" style="width: 100%; max-width: 400px; padding: 20px;">
                    <div class="login-tabs">
                        <button class="login-tab-button active" data-form="admin-login-form">Admin Login</button>
                        <button class="login-tab-button" data-form="user-login-form">User Login</button>
                    </div>
                    
                    <div id="admin-login-form-container" class="login-form-container active">
                        <form id="login-form">
                            <h2>Admin Login</h2>
                            <input type="email" id="login-email" placeholder="Email" required>
                            <input type="password" id="login-password" placeholder="Password" required>
                            <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
                        </form>
                    </div>

                    <div id="user-login-form-container" class="login-form-container">
                        <form id="user-login-form">
                            <h2>User Login</h2>
                            <p style="font-size: 0.8rem; text-align: center; margin-bottom: 1rem;">Use the Name and Mobile Number you used for booking.</p>
                            <input type="text" id="user-login-name" placeholder="Your Name (as on ticket)" required>
                            <input type="tel" id="user-login-mobile" placeholder="Your Mobile Number" required>
                            <button type="submit" class="btn btn-primary" style="width:100%;">View My Tickets</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- USER DASHBOARD PAGE -->
        <div id="user-dashboard-page" class="page">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 id="user-welcome-message" style="margin-bottom:0;"></h2>
                    <button id="user-logout-btn" class="btn btn-danger">Logout</button>
                </div>
                <div id="user-tickets-container">
                    <!-- User's tickets will be rendered here -->
                </div>
            </div>
        </div>


        <!-- ADMIN DASHBOARD PAGE -->
        <div id="admin-dashboard-page" class="page">
             <div class="container">
                <h2>Admin Dashboard</h2>
                <div class="admin-nav">
                    <button id="show-manage-lottery" class="btn active">Manage Lottery</button>
                    <button id="show-manage-tickets" class="btn">Manage Tickets</button>
                    <button id="show-reports" class="btn">Book Details</button>
                    <button id="logout-btn" class="btn btn-danger">Logout</button>
                </div>

                <!-- Tab 1: Manage Lotteries -->
                <div id="manage-lottery-tab" class="admin-tab-content active">
                    <div id="admin-lottery-main-view">
                        <div class="lottery-card">
                            <div class="lottery-card-content">
                                <form id="upload-lottery-form">
                                    <input type="hidden" id="editing-lottery-id">
                                    <input type="hidden" id="existing-image-url"> <!-- To keep old base64 if no new file is selected -->
                                    <h4 id="upload-form-title">Upload New Lottery</h4>
                                    <input type="text" id="lottery-title" placeholder="Lottery Title" required>
                                    <textarea id="lottery-details" placeholder="Lottery Details/Description" required></textarea>
                                    
                                    <label for="lottery-image-file">Lottery Image</label>
                                    <input type="file" id="lottery-image-file" accept="image/*">
                                    <img id="image-preview" src="" alt="Image Preview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none; border-radius: 8px;">

                                    <input type="number" id="lottery-ticket-price" placeholder="Ticket Price (‚Çπ)" required style="margin-top: 1rem;">
                                    <label for="lottery-datetime">Draw Date & Time</label>
                                    <input type="datetime-local" id="lottery-datetime" required>
                                    
                                    <div id="prize-inputs-container" style="margin-top: 1rem;">
                                        <label>Prizes</label>
                                    </div>
                                    <button type="button" id="add-prize-btn" class="btn" style="margin-bottom: 1rem;"><i class="fas fa-plus"></i> Add Prize</button>

                                    <button type="submit" class="btn btn-primary" id="upload-lottery-submit-btn">Upload Lottery</button>
                                    <button type="button" class="btn" id="cancel-edit-btn" style="display:none; margin-top:10px;">Cancel Edit</button>
                                </form>
                            </div>
                        </div>
                        <hr style="margin: 25px 0; border-color: var(--glass-border);">
                        <h3>Upcoming Lotteries</h3>
                        <div id="upcoming-lottery-list"></div>
                        <hr style="margin: 25px 0; border-color: var(--glass-border);">
                        <h3>Past Lotteries (History)</h3>
                        <div id="past-lottery-list"></div>
                    </div>
                    <div id="admin-lottery-ticket-view" style="display:none;">
                        <button id="back-to-admin-lotteries-btn" class="btn" style="margin-bottom: 20px;">&larr; Back to Lotteries</button>
                        <div id="admin-ticket-lottery-details-container"></div>
                        <div class="search-container">
                            <i class="fas fa-search"></i><input type="text" id="admin-ticket-search" placeholder="Search tickets...">
                        </div>
                        <div class="table-wrapper">
                            <table id="admin-specific-ticket-table">
                                <thead><tr><th>Ticket #</th><th>Name</th><th>Mobile</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Manage ALL Tickets -->
                <div id="manage-tickets-tab" class="admin-tab-content">
                    <h3>Manage All Booked Tickets</h3>
                    <div class="table-wrapper">
                        <table id="ticket-management-table">
                            <thead><tr><th>Ticket #</th><th>Name</th><th>Mobile</th><th>Lottery</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab 3: Reports / Book Details -->
                <div id="reports-tab" class="admin-tab-content">
                    <h3>Book & Sales Reports</h3>
                    <div id="report-lottery-list-view">
                        <p>Select a lottery to view its detailed sales report.</p>
                        <div id="report-lottery-list"></div>
                    </div>
                    <div id="report-details-view" style="display:none;">
                        <button id="back-to-reports-list-btn" class="btn" style="margin-bottom: 20px;"><i class="fas fa-arrow-left"></i> Back to Lottery List</button>
                        <h3 id="report-details-title"></h3>
                        <div class="table-wrapper">
                            <table id="report-details-table">
                                <thead><tr><th>Buyer Name</th><th>Sold Tickets</th><th>Total Amount (‚Çπ)</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="buy-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="buy-modal-title">Buy Tickets</h2><form id="buy-ticket-form"><input type="text" id="buyer-name" placeholder="Your Name" required><input type="tel" id="buyer-mobile" placeholder="Mobile Number" required><label for="ticket-quantity">Quantity</label><input type="number" id="ticket-quantity" placeholder="Enter quantity" min="1" value="1" required><button type="submit" class="btn btn-primary" style="width:100%;">Request Ticket</button></form></div></div>
    <div id="admin-select-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Contact an Admin</h2><p>Please select an admin to send your ticket request via WhatsApp.</p><ul id="admin-list" style="list-style:none; padding:0;"></ul></div></div>
    <div id="edit-ticket-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Edit Ticket Holder Info</h2><form id="edit-ticket-form"><input type="hidden" id="edit-purchase-id"><label for="edit-buyer-name">Buyer's Name</label><input type="text" id="edit-buyer-name" required><label for="edit-buyer-mobile">Buyer's Mobile</label><input type="tel" id="edit-buyer-mobile" required><label for="edit-ticket-status">Status</label><select id="edit-ticket-status"><option value="pending">Pending</option><option value="confirmed">Confirmed</option><option value="rejected">Rejected</option></select><button type="submit" class="btn btn-primary" style="width:100%;">Save Changes</button></form></div></div>
    
    <!-- Admin Book Ticket Modal -->
    <div id="admin-book-ticket-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="admin-book-modal-title">Book Tickets</h2>
            <form id="admin-book-ticket-form">
                <input type="hidden" id="admin-book-lottery-id">
                <input type="text" id="admin-book-buyer-name" placeholder="Buyer's Name" required>
                <input type="tel" id="admin-book-buyer-mobile" placeholder="Mobile Number" required>
                <label for="admin-book-ticket-quantity">Quantity</label>
                <input type="number" id="admin-book-ticket-quantity" placeholder="Enter quantity" min="1" value="1" required>
                <button type="submit" class="btn btn-primary" style="width:100%;">Book and Confirm Ticket</button>
            </form>
        </div>
    </div>
    
    <!-- Lottery Details Modal -->
    <div id="lottery-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-details-title">Lottery Details</h2>
            <img id="modal-details-img" src="" alt="Lottery Image" style="width: 100%; border-radius: 12px; margin-bottom: 15px;">
            <p><strong>Draw Date:</strong> <span id="modal-details-datetime"></span></p>
            <p id="modal-details-desc"></p>
            
            <h4 style="text-align: left; margin-top: 20px;">Prizes</h4>
            <div id="modal-details-prizes" style="margin-bottom: 20px;"></div>

            <h3>üèÜ Winners List</h3>
            <div class="table-wrapper">
                <table id="modal-details-winners-table">
                    <thead><tr><th>Ticket No.</th><th>Name</th><th>Prize</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <h3>üéüÔ∏è All Other Tickets</h3>
            <div class="table-wrapper">
                 <table id="modal-details-losers-table">
                    <thead><tr><th>Ticket No.</th><th>Name</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- Status Popup -->
    <div id="status-popup"></div>

    <!-- BOTTOM NAVIGATION BAR -->
    <nav class="bottom-nav">
        <button class="nav-btn active" data-page="lottery-page"><i class="fas fa-home"></i> Home</button>
        <button class="nav-btn" data-page="live-page"><i class="fas fa-play-circle"></i> Live</button>
        <button class="nav-btn" data-page="history-page"><i class="fas fa-history"></i> History</button>
        <button class="nav-btn" data-page="lottery-for-tickets-page"><i class="fas fa-clipboard-list"></i> Tickets</button>
        <button id="auth-nav-btn" class="nav-btn" data-page="login-page"><i class="fas fa-sign-in-alt"></i> Login</button>
    </nav>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVRvgTNHgL288wHQNuLxaeiF4UQV4xSIQ",
            authDomain: "sinthateamtambola.firebaseapp.com",
            databaseURL: "https://sinthateamtambola-default-rtdb.firebaseio.com",
            projectId: "sinthateamtambola",
            storageBucket: "sinthateamtambola.appspot.com",
            messagingSenderId: "678704264927",
            appId: "1:678704264927:web:f6f1e06531bbb890179b6a",
        };

        // --- INITIALIZE FIREBASE ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const liveDrawRef = db.ref('liveDraw');

        // --- GLOBAL STATE & CACHES ---
        let currentLotteryId = null;
        let purchaseData = {};
        let allLotteriesCache = {};
        let allTicketsCache = {};
        let allResultsCache = {};
        let lotteryTicketCounts = {};
        let currentLiveDrawData = {}; 
        let countdownInterval;
        let autoDrawTimeout = null; 
        let ttsEnabled = false;
        let lastAnnouncementTimestamp = 0;

        // --- DOM ELEMENTS ---
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-btn');
        const modals = document.querySelectorAll('.modal');
        const statusPopup = document.getElementById('status-popup');
        const namePickerDisplay = document.getElementById('name-picker-display');
        const namePickerAudio = document.getElementById('name-picker-audio');
        const slotMachineAudio = document.getElementById('slot-machine-audio');
        let namePickerInterval = null;
        const authNavBtn = document.getElementById('auth-nav-btn');
        
        // --- CORE APP LOGIC ---

        // 1. PAGE NAVIGATION & AUTH STATE UI
        const updateUserNav = () => {
            const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            
            if (auth.currentUser) { // Admin logged in
                authNavBtn.innerHTML = `<i class="fas fa-tachometer-alt"></i> Dashboard`;
                authNavBtn.dataset.page = 'admin-dashboard-page';
            } else if (loggedInUser) { // User logged in
                authNavBtn.innerHTML = `<i class="fas fa-user-circle"></i> My Account`;
                authNavBtn.dataset.page = 'user-dashboard-page';
            } else { // Guest
                authNavBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i> Login`;
                authNavBtn.dataset.page = 'login-page';
            }
        };

        const showPage = (pageId) => {
            pages.forEach(page => page.classList.toggle('active', page.id === pageId));
            navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
            updateUserNav(); // Update nav on every page change
            if (pageId === 'lottery-page') {
                startCountdownTimers();
            } else {
                if (countdownInterval) clearInterval(countdownInterval);
            }
            if (pageId === 'user-dashboard-page') {
                renderUserDashboard();
            }
            window.scrollTo(0, 0);
        };
        
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                showPage(pageId);
            });
        });
        
        // 2. MODAL HANDLING
        const openModal = (modalId) => document.getElementById(modalId).classList.add('show');
        const closeModal = () => modals.forEach(modal => modal.classList.remove('show'));
        document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', closeModal));
        window.addEventListener('click', (e) => modals.forEach(m => { if (e.target === m) closeModal(); }));

        // 3. UTILITY FUNCTIONS
        const showStatus = (message, isSuccess = true) => {
            statusPopup.textContent = message;
            const successColor = "rgba(129, 199, 132, 0.7)";
            const errorColor = "rgba(229, 115, 115, 0.7)";
            statusPopup.style.backgroundColor = isSuccess ? successColor : errorColor;
            statusPopup.classList.add('show');
            setTimeout(() => statusPopup.classList.remove('show'), 3000);
        };
        
        const generateAlphaNumeric = (length) => {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        };

        const filterTable = (input, table) => {
            const filter = input.value.toUpperCase();
            const rows = table.getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                let textContent = rows[i].textContent || rows[i].innerText;
                if (textContent.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        };
        document.getElementById('public-ticket-search').addEventListener('keyup', () => filterTable(document.getElementById('public-ticket-search'), document.querySelector('#public-lottery-ticket-table tbody')));
        document.getElementById('admin-ticket-search').addEventListener('keyup', () => filterTable(document.getElementById('admin-ticket-search'), document.querySelector('#admin-specific-ticket-table tbody')));
        document.getElementById('search-bar').addEventListener('keyup', () => {
            const filter = document.getElementById('search-bar').value.toUpperCase();
            const cards = document.querySelectorAll('#lottery-list .lottery-card');
            cards.forEach(card => {
                const text = card.textContent || card.innerText;
                card.style.display = text.toUpperCase().includes(filter) ? "" : "none";
            });
        });

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 4. DATA LISTENERS
        db.ref('lotteries').on('value', (snapshot) => {
            allLotteriesCache = snapshot.val() || {};
            renderAllLotteryLists();
            if (auth.currentUser && document.getElementById('manage-lottery-tab').classList.contains('active')) {
                loadManageableLotteries();
            }
        });
        
        db.ref('tickets').on('value', snapshot => {
            const ticketsData = snapshot.val() || {};
            Object.keys(ticketsData).forEach(key => {
                ticketsData[key].key = key;
            });
            allTicketsCache = ticketsData;
            processTicketCounts(); 
            if (auth.currentUser) {
                loadManageableLotteries();
                loadAllTicketsManagementTable();
                if (document.getElementById('reports-tab').classList.contains('active')) {
                    loadReportsData();
                }
                const adminTicketView = document.getElementById('admin-lottery-ticket-view');
                if(adminTicketView.style.display === 'block' && adminTicketView.dataset.currentLottery) {
                    viewAdminLotteryTickets(adminTicketView.dataset.currentLottery);
                }
            }
        });

        db.ref('lotteryResults').on('value', (snapshot) => {
            allResultsCache = snapshot.val() || {};
        });

        // 5. RENDER LOTTERY LISTS & COUNTDOWN
        const startCountdownTimers = () => {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                document.querySelectorAll('.countdown').forEach(el => {
                    const drawTime = new Date(el.dataset.drawTime).getTime();
                    const now = new Date().getTime();
                    const distance = drawTime - now;

                    if (distance < 0) {
                        el.innerHTML = "DRAW COMPLETED";
                        const card = el.closest('.lottery-card');
                        if (card) {
                            const buyButton = card.querySelector('.buy-btn');
                            if (buyButton) {
                                buyButton.disabled = true;
                                buyButton.textContent = 'Draw Closed';
                            }
                        }
                        return;
                    }
                    const d = Math.floor(distance/(1000*60*60*24)), h = Math.floor((distance%(1000*60*60*24))/(1000*60*60)), m = Math.floor((distance%(1000*60*60))/(1000*60)), s = Math.floor((distance%(1000*60))/1000);
                    el.innerHTML = `<strong>${d}d ${h}h ${m}m ${s}s</strong>`;
                });
            }, 1000);
        };

        const renderAllLotteryLists = () => {
            const now = new Date();
            const lotteries = Object.entries(allLotteriesCache).sort((a,b) => new Date(b[1].datetime) - new Date(a[1].datetime));
            const upcoming = lotteries.filter(([,l]) => new Date(l.datetime) > now).sort((a,b) => new Date(a[1].datetime) - new Date(b[1].datetime));
            const past = lotteries.filter(([,l]) => new Date(l.datetime) <= now);
            renderLotteryCards(upcoming, document.getElementById('lottery-list'), 'home');
            renderLotteryCards(past, document.getElementById('lottery-history-list'), 'history');
            renderLotteryCards(lotteries, document.getElementById('lottery-selection-list'), 'selection');
            startCountdownTimers();
        };

        const renderLotteryCards = (lotteryArray, element, type) => {
            element.innerHTML = '';
            if (lotteryArray.length === 0) {
                 element.innerHTML = `<p style="text-align: center;">No lotteries found.</p>`;
                 return;
            }
            lotteryArray.forEach(([id, lottery]) => {
                const card = document.createElement('div');
                card.className = 'lottery-card';
                let contentHtml = `
                    <img src="${lottery.imageUrl || 'https://via.placeholder.com/600x400.png?text=No+Image'}" alt="${lottery.title}" loading="lazy">
                    <div class="lottery-card-content">
                        <h3>${lottery.title}</h3>
                        <p>${lottery.details || 'No description available.'}</p>
                        <p><strong>Draw on:</strong> ${new Date(lottery.datetime).toLocaleString()}</p>
                    </div>`;
                if (type === 'home') {
                    contentHtml += `<div class="lottery-card-content" style="padding-top:0;">
                        <p class="countdown" data-draw-time="${lottery.datetime}" style="text-align:center; font-size:1.1rem; color: var(--secondary-color);"></p>
                        <div class="lottery-card-buttons">
                           <button class="btn btn-primary buy-btn" data-id="${id}">Buy Ticket (‚Çπ${lottery.price})</button>
                        </div>
                    </div>`;
                } else if (type === 'history') {
                    card.setAttribute('onclick', `viewHistoryDetails('${id}')`);
                } else if (type === 'selection') {
                    card.setAttribute('onclick', `viewPublicLotteryTickets('${id}')`);
                }
                card.innerHTML = contentHtml;
                element.appendChild(card);
            });
        };

        // 6. TICKET PURCHASE FLOW & CONFIRMATION LINK
        document.getElementById('lottery-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('buy-btn')) {
                e.stopPropagation();
                currentLotteryId = e.target.dataset.id;
                const lottery = allLotteriesCache[currentLotteryId];
                document.getElementById('buy-modal-title').textContent = `Buy Tickets for ${lottery.title}`;
                openModal('buy-modal');
            }
        });
        
        document.getElementById('buy-ticket-form').addEventListener('submit', (e) => {
            e.preventDefault();
            purchaseData = {
                name: document.getElementById('buyer-name').value, mobile: document.getElementById('buyer-mobile').value,
                quantity: document.getElementById('ticket-quantity').value, lotteryId: currentLotteryId,
            };
            db.ref('admins').once('value', (snapshot) => {
                const admins = snapshot.val(); const adminListEl = document.getElementById('admin-list');
                adminListEl.innerHTML = '';
                if(admins) {
                    Object.values(admins).forEach(admin => { 
                        const li = document.createElement('li');
                        li.dataset.number = admin.whatsappNumber;
                        li.textContent = admin.name;
                        li.style.cssText = "padding: 12px; background: rgba(0,0,0,0.2); margin-bottom: 8px; border-radius: 8px; cursor: pointer; transition: background 0.2s;";
                        adminListEl.appendChild(li);
                    });
                    closeModal(); openModal('admin-select-modal');
                } else { showStatus('No admins available to contact.', false); }
            });
        });

        document.getElementById('admin-list').addEventListener('click', (e) => {
            if (e.target.tagName !== 'LI' || !e.target.dataset.number) return;
            
            const confirmationCode = generateAlphaNumeric(6);
            const confirmationLink = `${window.location.href.split('#')[0]}#confirm=${confirmationCode}`;
            
            const newPurchaseRef = db.ref('tickets').push();
            const tickets = Array.from({length: purchaseData.quantity}, () => Math.floor(100000 + Math.random() * 900000));
            newPurchaseRef.set({ 
                ...purchaseData, 
                tickets, 
                status: 'pending', 
                timestamp: new Date().toISOString(),
                confirmationCode: confirmationCode 
            });

            const lotteryTitle = allLotteriesCache[purchaseData.lotteryId].title;
            const message = `Hello, I'd like to buy ${purchaseData.quantity} ticket(s) for "${lotteryTitle}".\nName: ${purchaseData.name}\nMobile: ${purchaseData.mobile}\n\n-----\nFor Admin Use:\nClick to confirm after payment: ${confirmationLink}`;
            window.open(`https://wa.me/${e.target.dataset.number}?text=${encodeURIComponent(message)}`, '_blank');
            closeModal(); showStatus('Request sent! Please complete payment on WhatsApp.');
            document.getElementById('buy-ticket-form').reset();
        });

        const handleUrlConfirmation = () => {
            if (!window.location.hash.startsWith('#confirm=')) return;
            
            const code = window.location.hash.substring(9);
            history.pushState("", document.title, window.location.pathname + window.location.search); // Clean URL
            
            if (!auth.currentUser) {
                showStatus("Please log in as an Admin to confirm tickets.", false);
                showPage('login-page');
                return;
            }

            db.ref('tickets').orderByChild('confirmationCode').equalTo(code).once('value', snapshot => {
                if (snapshot.exists()) {
                    const [purchaseId, purchaseData] = Object.entries(snapshot.val())[0];
                    db.ref(`tickets/${purchaseId}`).update({
                        status: 'confirmed',
                        confirmationCode: null // Invalidate the code
                    }).then(() => {
                        showStatus(`Ticket for ${purchaseData.name} confirmed successfully!`, true);
                    });
                } else {
                    showStatus("Confirmation link is invalid or already used.", false);
                }
            });
        };
        
        // 7. PUBLIC-FACING PAGE VIEWS
        window.viewPublicLotteryTickets = async (lotteryId) => {
            const lottery = allLotteriesCache[lotteryId];
            document.getElementById('ticket-lottery-details-container').innerHTML = `<div class="lottery-card"><img src="${lottery.imageUrl}" alt="${lottery.title}"><div class="lottery-card-content"><h3>${lottery.title}</h3><p>${lottery.details}</p></div></div>`;
            const tableBody = document.querySelector('#public-lottery-ticket-table tbody');
            tableBody.innerHTML = '<tr><td colspan="3">Loading tickets...</td></tr>';
            const ticketsSnapshot = await db.ref('tickets').orderByChild('lotteryId').equalTo(lotteryId).once('value');
            let ticketsHtml = '';
            if (ticketsSnapshot.exists()) {
                ticketsSnapshot.forEach(purchaseSnap => {
                    const p = purchaseSnap.val();
                    if(p.status === 'confirmed') { 
                        p.tickets.forEach(ticketNum => {
                            ticketsHtml += `<tr><td>${ticketNum}</td><td>${p.name}</td><td class="status-${p.status}">${p.status}</td></tr>`;
                        });
                    }
                });
            }
            tableBody.innerHTML = ticketsHtml || '<tr><td colspan="3">No confirmed tickets found for this draw.</td></tr>';
            showPage('ticket-details-for-lottery-page');
        };

        window.viewHistoryDetails = async (lotteryId) => {
            const lottery = allLotteriesCache[lotteryId];
            const result = allResultsCache[lotteryId];

            document.getElementById('modal-details-title').textContent = lottery.title;
            document.getElementById('modal-details-img').src = lottery.imageUrl || 'https://via.placeholder.com/600x400.png?text=No+Image';
            document.getElementById('modal-details-datetime').textContent = new Date(lottery.datetime).toLocaleString();
            document.getElementById('modal-details-desc').textContent = lottery.details;
            
            const prizeListEl = document.getElementById('modal-details-prizes');
            prizeListEl.innerHTML = '';
            if (lottery.prizes && lottery.prizes.length > 0) {
                const prizeList = document.createElement('ul');
                prizeList.style.paddingLeft = '20px';
                lottery.prizes.forEach(prize => {
                    const li = document.createElement('li');
                    li.textContent = prize;
                    li.style.color = 'var(--text-secondary-light)';
                    prizeList.appendChild(li);
                });
                prizeListEl.appendChild(prizeList);
            } else {
                prizeListEl.innerHTML = '<p>No prize information available.</p>';
            }

            const winnersTbody = document.querySelector('#modal-details-winners-table tbody');
            const losersTbody = document.querySelector('#modal-details-losers-table tbody');
            winnersTbody.innerHTML = ''; 
            losersTbody.innerHTML = '';

            if (result && (result.allWinners || result.allLosers)) {
                (result.allWinners || []).forEach(p => winnersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-win">${p.prize || 'Winner'}</td></tr>`);
                if (winnersTbody.innerHTML === '') {
                    winnersTbody.innerHTML = '<tr><td colspan="3">No winners were recorded for this draw.</td></tr>';
                }
                (result.allLosers || []).forEach(p => losersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-loss">Not a winner</td></tr>`);
                 if (losersTbody.innerHTML === '') {
                    losersTbody.innerHTML = '<tr><td colspan="3">No other tickets were recorded.</td></tr>';
                }
            } else {
                winnersTbody.innerHTML = '<tr><td colspan="3">Results not yet available for this draw.</td></tr>';
                losersTbody.innerHTML = '<tr><td colspan="3">Results not yet available for this draw.</td></tr>';
            }
            
            openModal('lottery-details-modal');
        };

        // 8. LIVE DRAW PAGE & SLOT MACHINE LOGIC
        const runNamePickerAnimation = (allParticipants, finalParticipant, duration) => {
            if (namePickerInterval) clearInterval(namePickerInterval);
            if (allParticipants.length === 0) {
                namePickerDisplay.querySelector('span').textContent = '...';
                return;
            };

            const nameSpinnerContainer = document.getElementById('name-spinner-container');
            const displaySpan = namePickerDisplay.querySelector('span');
            namePickerDisplay.classList.add('picking');
            namePickerDisplay.classList.remove('picked');
            nameSpinnerContainer.classList.add('is-cycling');

            if (namePickerAudio) {
                namePickerAudio.currentTime = 0;
                namePickerAudio.play().catch(e => console.log("Audio play blocked by browser."));
            }

            namePickerInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * allParticipants.length);
                const randomParticipant = allParticipants[randomIndex];
                displaySpan.textContent = `${randomParticipant.name} (${randomParticipant.ticket})`;
            }, 100);

            setTimeout(() => {
                clearInterval(namePickerInterval);
                namePickerInterval = null;
                displaySpan.textContent = `${finalParticipant.name} (${finalParticipant.ticket})`;
                namePickerDisplay.classList.remove('picking');
                namePickerDisplay.classList.add('picked');
                nameSpinnerContainer.classList.remove('is-cycling');
                if (namePickerAudio) {
                    namePickerAudio.pause();
                }
            }, duration);
        };
        
        const REEL_SYMBOLS = 25; 
        const SPIN_DURATION_BASE = 3000;

        const initializeSlotMachine = () => {
            for (let i = 1; i <= 3; i++) {
                const reel = document.getElementById(`reel${i}`);
                if (!reel) continue;
                reel.innerHTML = '';
                const defaultSymbol = document.createElement('div');
                defaultSymbol.className = 'slot-symbol';
                defaultSymbol.textContent = '...';
                reel.appendChild(defaultSymbol);
            }
        };

        const resetSlotMachine = () => {
             for (let i = 1; i <= 3; i++) {
                const reel = document.getElementById(`reel${i}`);
                if (!reel) continue;
                
                reel.style.transition = 'none';
                reel.style.transform = 'translateY(0)';
                reel.innerHTML = '';
                
                const defaultSymbol = document.createElement('div');
                defaultSymbol.className = 'slot-symbol';
                defaultSymbol.textContent = '...';
                reel.appendChild(defaultSymbol);
            }
        };

        const spinSlotMachine = (resultStatus) => {
            if (slotMachineAudio) {
                slotMachineAudio.currentTime = 0;
                slotMachineAudio.play().catch(e => console.log("Audio play blocked by browser."));
            }

            const finalSymbols = [];
            if (resultStatus.toLowerCase() === 'win') {
                finalSymbols.push('win', 'win', 'win');
            } else {
                const lossCombo = [['win', 'win', 'loss'], ['win', 'loss', 'win'], ['loss', 'win', 'win'], ['loss', 'loss', 'win'], ['win', 'loss', 'loss'], ['loss', 'win', 'loss'], ['loss', 'loss', 'loss']];
                const chosenCombo = lossCombo[Math.floor(Math.random() * lossCombo.length)];
                shuffleArray(chosenCombo);
                finalSymbols.push(...chosenCombo);
            }

            for (let i = 1; i <= 3; i++) {
                const reel = document.getElementById(`reel${i}`);
                const finalSymbol = finalSymbols[i-1];
                if (!reel) continue;

                reel.style.transition = 'none';
                reel.style.transform = 'translateY(0)';
                reel.offsetHeight; 

                reel.innerHTML = '';
                const symbolOptions = ['win', 'loss'];
                for(let j = 0; j < REEL_SYMBOLS; j++) {
                    const symbolType = symbolOptions[Math.floor(Math.random() * symbolOptions.length)];
                    const symbolEl = document.createElement('div');
                    symbolEl.className = `slot-symbol ${symbolType}`;
                    symbolEl.textContent = symbolType;
                    reel.appendChild(symbolEl);
                }
                const finalSymbolEl = document.createElement('div');
                finalSymbolEl.className = `slot-symbol ${finalSymbol}`;
                finalSymbolEl.textContent = finalSymbol;
                reel.appendChild(finalSymbolEl);
                
                const symbolHeight = reel.querySelector('.slot-symbol').clientHeight;
                if (symbolHeight === 0) { 
                     console.error("Slot machine is not visible, cannot calculate spin.");
                     return;
                }
                const totalDistance = REEL_SYMBOLS * symbolHeight;
                const spinDuration = SPIN_DURATION_BASE + (i * 500);

                reel.style.transition = `transform ${spinDuration}ms cubic-bezier(0.25, 0.1, 0.25, 1)`;
                reel.style.transform = `translateY(-${totalDistance}px)`;
            }
        };
        
        const announceResult = (ticket, name, result) => {
            const resultText = result.toLowerCase();
            const message = `Result for ${name}, ticket number ${ticket}. The result is ${resultText}.`;
            
            showStatus(message, resultText === 'win');

            if (!ttsEnabled) return;

            try {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.lang = 'en-US';
                    speechSynthesis.speak(utterance);
                }
            } catch (error) {
                console.error("Text-to-Speech failed:", error);
            }
        };
        
        liveDrawRef.on('value', (snapshot) => {
            const data = snapshot.val();
            currentLiveDrawData = data; 
            if (!data) return;

            let lastResultTimestamp = document.body.dataset.lastResultTimestamp || '';

            document.getElementById('live-status').textContent = data.lotteryTitle ? `${data.lotteryTitle}: ${data.status}` : data.status;

            if (auth.currentUser) {
                const startDrawBtn = document.getElementById('start-draw-btn');
                startDrawBtn.disabled = data.isAutoDrawing && (data.isPicking || data.result);
                if (data.isAutoDrawing) {
                    startDrawBtn.textContent = 'Stop Auto-Draw';
                    startDrawBtn.classList.remove('btn-primary');
                    startDrawBtn.classList.add('btn-danger');
                } else {
                    startDrawBtn.textContent = 'Start Auto-Draw';
                    startDrawBtn.classList.add('btn-primary');
                    startDrawBtn.classList.remove('btn-danger');
                }
            }
            
            if (data.isPicking && data.currentPick && namePickerDisplay.dataset.lastPickId !== data.currentPick.ticket) {
                const allParticipants = (data.participants || []).concat(data.allWinners || [], data.allLosers || []);
                runNamePickerAnimation(allParticipants, data.currentPick, 4000);
                namePickerDisplay.dataset.lastPickId = data.currentPick.ticket;
            } 
            else if (!data.isPicking && data.currentPick) {
                 namePickerDisplay.querySelector('span').textContent = `${data.currentPick.name} (${data.currentPick.ticket})`;
                 namePickerDisplay.classList.remove('picking');
            }

            if (data.result && lastResultTimestamp !== data.result.timestamp) {
                spinSlotMachine(data.result.status);
                document.body.dataset.lastResultTimestamp = data.result.timestamp;
            }
            
            if (data.announcement && data.announcement.timestamp > lastAnnouncementTimestamp) {
                lastAnnouncementTimestamp = data.announcement.timestamp;
                announceResult(data.announcement.ticket, data.announcement.name, data.announcement.result);
            }

            const winnersTbody = document.querySelector('#winners-table tbody');
            const losersTbody = document.querySelector('#losers-table tbody');
            winnersTbody.innerHTML = ''; 
            losersTbody.innerHTML = '';
            (data.allWinners || []).forEach(p => { winnersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-win">${p.prize || 'Winner'}</td></tr>`; });
            (data.allLosers || []).forEach(p => { losersTbody.innerHTML += `<tr><td>${p.ticket}</td><td>${p.name}</td><td class="status-loss">Not a winner</td></tr>`; });
            
            if (data.isReset) {
                 namePickerDisplay.classList.remove('picking', 'picked');
                 namePickerDisplay.querySelector('span').textContent = 'STARTING SOON';
                 namePickerDisplay.dataset.lastPickId = "";
                 
                 resetSlotMachine();
                 document.body.dataset.lastResultTimestamp = "";
                 
                 document.getElementById('live-result-search').value = '';
                 document.getElementById('live-search-result-container').style.display = 'none';

                 if (autoDrawTimeout) clearTimeout(autoDrawTimeout);
                 autoDrawTimeout = null;
                 
                 if(auth.currentUser) liveDrawRef.update({ isReset: null });
            }
        });
        
        const performSingleDraw = () => {
            liveDrawRef.once('value', snapshot => {
                const data = snapshot.val();
                if (!data || !data.isAutoDrawing) {
                    if (autoDrawTimeout) clearTimeout(autoDrawTimeout);
                    autoDrawTimeout = null;
                    return;
                }
                
                const participants = data.participants || [];
                const allWinners = data.allWinners || [];
                const prizes = data.prizes || [];

                if (participants.length === 0 || allWinners.length >= prizes.length) {
                    let finalStatus = "Auto-draw finished: All participants have been drawn.";
                    db.ref(`lotteryResults/${data.lotteryId}`).set({ allWinners: data.allWinners, allLosers: data.allLosers });
                    if (allWinners.length >= prizes.length) {
                        finalStatus = "Auto-draw finished: All prizes have been awarded!";
                    }
                    liveDrawRef.update({ isAutoDrawing: false, status: finalStatus, isPicking: false, currentPick: null, result: null });
                    return;
                }

                const pickedParticipant = participants.shift();
                
                const prizesLeft = prizes.length - allWinners.length;
                const participantsLeft = participants.length + 1;
                const winChance = prizesLeft > 0 ? (prizesLeft / participantsLeft) : 0;
                const isWin = Math.random() < winChance;
                const resultStatus = isWin ? 'WIN' : 'LOSS';

                const finalWinners = [...allWinners];
                const finalLosers = [...(data.allLosers || [])];
                let prizeWon = null;
                
                if (isWin) {
                    prizeWon = prizes[finalWinners.length];
                    pickedParticipant.prize = prizeWon;
                    finalWinners.push(pickedParticipant);
                } else {
                    finalLosers.push(pickedParticipant);
                }
                
                const finalStatusText = isWin
                    ? `üéâ ${pickedParticipant.name} WINS ${prizeWon}! üéâ`
                    : `${pickedParticipant.name} did not win. Better luck next time!`;
                
                const nameSpinTime = 5000;
                const resultSpinTime = 5000;
                const pauseAfterResult = 3000;

                liveDrawRef.update({
                    status: `Picking next participant...`,
                    isPicking: true,
                    currentPick: pickedParticipant,
                    participants: participants,
                    result: null
                });

                setTimeout(() => {
                    liveDrawRef.update({
                        status: `Spinning result for ${pickedParticipant.name}...`,
                        isPicking: false,
                        result: { status: resultStatus, timestamp: Date.now() }
                    });

                    setTimeout(() => {
                        liveDrawRef.update({
                            status: finalStatusText,
                            allWinners: finalWinners,
                            allLosers: finalLosers,
                            currentPick: null, 
                            result: null,
                            announcement: {
                                ticket: pickedParticipant.ticket,
                                name: pickedParticipant.name,
                                result: resultStatus,
                                timestamp: Date.now()
                            }
                        }).then(() => {
                            if (autoDrawTimeout) clearTimeout(autoDrawTimeout);
                            autoDrawTimeout = setTimeout(performSingleDraw, pauseAfterResult);
                        });
                    }, resultSpinTime);
                }, nameSpinTime);
            });
        };

        document.getElementById('start-draw-btn').addEventListener('click', (e) => {
            const btn = e.target; btn.disabled = true;
            liveDrawRef.once('value', snapshot => {
                const data = snapshot.val();
                if (!data) { btn.disabled = false; return; }
                const isCurrentlyDrawing = data.isAutoDrawing || false;
                if (isCurrentlyDrawing) {
                    if (autoDrawTimeout) clearTimeout(autoDrawTimeout);
                    autoDrawTimeout = null;
                    liveDrawRef.update({ isAutoDrawing: false, status: "Auto-draw paused by admin." });
                } else {
                    if (!data.participants || data.participants.length === 0) { showStatus("No participants left to draw.", false); btn.disabled = false; return; }
                    if (data.allWinners && data.prizes && data.allWinners.length >= data.prizes.length) { showStatus("All prizes have been awarded.", false); btn.disabled = false; return; }
                    liveDrawRef.update({ isAutoDrawing: true });
                    performSingleDraw(); 
                }
            });
        });

        document.getElementById('reset-draw-btn').addEventListener('click', () => {
             if(confirm('This will clear the live draw board and stop any running draw. Are you sure?')) {
                 if (autoDrawTimeout) clearTimeout(autoDrawTimeout);
                 autoDrawTimeout = null;
                 liveDrawRef.set({ status: "Waiting for Admin...", isReset: true, participants: [], allWinners: [], allLosers: [], isAutoDrawing: false, isPicking: false, currentPick: null, result: null, announcement: null });
             }
        });

        // 9. ADMIN & USER AUTH & DASHBOARD
        auth.onAuthStateChanged(user => {
            document.getElementById('admin-controls').style.display = user ? 'block' : 'none';
            const pageId = document.querySelector('.page.active').id;
            const userIsOnAdminPage = pageId.startsWith('admin-');
            if (!user && userIsOnAdminPage) {
                showPage('lottery-page');
            } else {
                showPage(pageId);
            }
            if (user) {
                loadAllTicketsManagementTable();
                loadManageableLotteries();
            }
            updateUserNav();
            handleUrlConfirmation();
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
            .then(() => showPage('admin-dashboard-page'))
            .catch(error => showStatus(error.message, false));
        });
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

        document.querySelectorAll('.login-tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.login-tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.login-form-container').forEach(form => form.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.form + '-container').classList.add('active');
            });
        });

        // 10. USER LOGIN & DASHBOARD LOGIC
        document.getElementById('user-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('user-login-name').value.trim();
            const mobile = document.getElementById('user-login-mobile').value.trim();
            
            const userExists = Object.values(allTicketsCache).some(ticket => ticket.name.toLowerCase() === name.toLowerCase() && ticket.mobile === mobile);
            
            if (userExists) {
                sessionStorage.setItem('loggedInUser', JSON.stringify({ name, mobile }));
                showPage('user-dashboard-page');
            } else {
                showStatus("No tickets found for this Name and Mobile Number.", false);
            }
        });
        
        document.getElementById('user-logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('loggedInUser');
            showPage('lottery-page');
        });

        const renderUserDashboard = () => {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (!user) {
                showPage('login-page');
                return;
            }

            document.getElementById('user-welcome-message').textContent = `Welcome, ${user.name}!`;
            const container = document.getElementById('user-tickets-container');
            container.innerHTML = '<h3>My Tickets</h3>';

            const userTickets = Object.values(allTicketsCache).filter(t => t.name.toLowerCase() === user.name.toLowerCase() && t.mobile === user.mobile);
            
            if(userTickets.length === 0) {
                 container.innerHTML += '<p>You have not booked any tickets yet.</p>';
                 return;
            }
            
            const ticketsByLottery = userTickets.reduce((acc, purchase) => {
                const lotteryId = purchase.lotteryId;
                if (!acc[lotteryId]) {
                    acc[lotteryId] = [];
                }
                acc[lotteryId].push(purchase);
                return acc;
            }, {});

            for (const lotteryId in ticketsByLottery) {
                const lottery = allLotteriesCache[lotteryId];
                if (!lottery) continue;

                const lotteryResults = allResultsCache[lotteryId];
                
                let lotteryHtml = `<div class="lottery-card"><div class="lottery-card-content"><h4>${lottery.title}</h4>`;
                
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'table-wrapper';
                const table = document.createElement('table');
                table.innerHTML = `<thead><tr><th>Ticket No.</th><th>Status</th><th>Result</th></tr></thead><tbody>`;
                
                ticketsByLottery[lotteryId].forEach(purchase => {
                    purchase.tickets.forEach(ticketNum => {
                        let resultText = '-';
                        if (lotteryResults && lotteryResults.allWinners) {
                            const winnerInfo = lotteryResults.allWinners.find(w => w.ticket == ticketNum);
                            if (winnerInfo) {
                                resultText = `<strong class="status-win">WINNER! (${winnerInfo.prize})</strong>`;
                            } else {
                                resultText = `<span class="status-loss">Not a winner</span>`;
                            }
                        }
                        table.querySelector('tbody').innerHTML += `<tr><td>${ticketNum}</td><td class="status-${purchase.status}">${purchase.status}</td><td>${resultText}</td></tr>`;
                    });
                });

                tableWrapper.appendChild(table);
                lotteryHtml += tableWrapper.outerHTML + `</div></div>`;
                container.innerHTML += lotteryHtml;
            }
        };

        // 11. ADMIN DASHBOARD TABS
        document.querySelectorAll('#admin-dashboard-page .admin-nav .btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (e.target.id === 'logout-btn') return;
                document.querySelectorAll('#admin-dashboard-page .admin-nav .btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.admin-tab-content').forEach(t => t.classList.remove('active'));
                const tabId = e.target.id.replace('show-', '') + '-tab';
                document.getElementById(tabId).classList.add('active');
                if (tabId === 'reports-tab') {
                    loadReportsData();
                }
            });
        });

        // 12. ADMIN: MANAGE LOTTERIES & PRIZES
        const addPrizeInput = (value = '') => {
            const container = document.getElementById('prize-inputs-container');
            const prizeDiv = document.createElement('div');
            prizeDiv.style.display = 'flex'; prizeDiv.style.gap = '10px'; prizeDiv.style.marginBottom = '10px';
            prizeDiv.innerHTML = `<input type="text" class="lottery-prize-input" placeholder="Enter prize description" value="${value}" required style="margin-bottom: 0;"><button style="color: red;" type="button" class="btn btn-danger" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>`;
            container.appendChild(prizeDiv);
        };
        document.getElementById('add-prize-btn').addEventListener('click', () => addPrizeInput());
        
        function uploadImageAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        document.getElementById('lottery-image-file').addEventListener('change', function(event) {
            const preview = document.getElementById('image-preview');
            const file = event.target.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
                preview.src = '';
            }
        });

        const resetUploadForm = () => {
            document.getElementById('upload-lottery-form').reset();
            document.getElementById('editing-lottery-id').value = '';
            document.getElementById('existing-image-url').value = '';
            document.getElementById('upload-form-title').textContent = 'Upload New Lottery';
            document.getElementById('upload-lottery-submit-btn').textContent = 'Upload Lottery';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('prize-inputs-container').innerHTML = '<label>Prizes</label>';
            document.getElementById('image-preview').style.display = 'none';
            addPrizeInput();
        };

        document.getElementById('cancel-edit-btn').addEventListener('click', resetUploadForm);
        
        document.getElementById('upload-lottery-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('upload-lottery-submit-btn');
            const editingId = document.getElementById('editing-lottery-id').value;
            const prizeInputs = document.querySelectorAll('.lottery-prize-input');
            const prizes = Array.from(prizeInputs).map(input => input.value.trim()).filter(p => p);
            if (prizes.length === 0) { showStatus('Please add at least one prize.', false); return; }
            let imageUrl = document.getElementById('existing-image-url').value;
            const imageFile = document.getElementById('lottery-image-file').files[0];
            if (imageFile) {
                submitBtn.disabled = true; submitBtn.textContent = 'Converting Image...';
                try {
                    imageUrl = await uploadImageAsBase64(imageFile); 
                } catch (error) {
                    showStatus('Image conversion failed: ' + error.message, false);
                    submitBtn.disabled = false; submitBtn.textContent = editingId ? 'Save Changes' : 'Upload Lottery';
                    return; 
                } finally { submitBtn.disabled = false; submitBtn.textContent = editingId ? 'Save Changes' : 'Upload Lottery'; }
            } else if (!editingId) { showStatus('Please select an image for the new lottery.', false); return; }
            const lotteryData = { title: document.getElementById('lottery-title').value, details: document.getElementById('lottery-details').value, imageUrl: imageUrl, price: document.getElementById('lottery-ticket-price').value, datetime: document.getElementById('lottery-datetime').value, prizes: prizes };
            submitBtn.disabled = true; submitBtn.textContent = 'Saving...';
            const ref = editingId ? db.ref('lotteries/' + editingId) : db.ref('lotteries').push();
            ref.set(lotteryData).then(() => { showStatus(`Lottery ${editingId ? 'updated' : 'uploaded'} successfully!`); resetUploadForm(); }).catch(err => showStatus(err.message, false)).finally(() => { submitBtn.disabled = false; submitBtn.textContent = editingId ? 'Save Changes' : 'Upload Lottery'; });
        });
        
        const processTicketCounts = () => {
            const tempCounts = {};
            for (const purchase of Object.values(allTicketsCache)) {
                if (!tempCounts[purchase.lotteryId]) tempCounts[purchase.lotteryId] = { confirmed: 0 };
                if (purchase.status === 'confirmed') tempCounts[purchase.lotteryId].confirmed += purchase.tickets.length;
            }
            lotteryTicketCounts = tempCounts;
        };
        
        const loadManageableLotteries = () => {
            const upcomingListEl = document.getElementById('upcoming-lottery-list');
            const pastListEl = document.getElementById('past-lottery-list');
            upcomingListEl.innerHTML = ''; pastListEl.innerHTML = '';
            const now = new Date();
            const all = Object.entries(allLotteriesCache);
            const upcoming = all.filter(([,l]) => new Date(l.datetime) > now).sort((a,b) => new Date(a[1].datetime) - new Date(b[1].datetime));
            const past = all.filter(([,l]) => new Date(l.datetime) <= now).sort((a,b) => new Date(b[1].datetime) - new Date(a[1].datetime));
            const renderList = (lotteries, element) => {
                if (lotteries.length === 0) { element.innerHTML = '<p>No lotteries found in this category.</p>'; return; }
                lotteries.forEach(([id, lottery]) => {
                    const soldCount = lotteryTicketCounts[id] ? lotteryTicketCounts[id].confirmed : 0;
                    const item = document.createElement('div'); item.className = 'manageable-lottery-item';
                    item.innerHTML = `<div class="manageable-lottery-item-info" onclick="viewAdminLotteryTickets('${id}')"><strong>${lottery.title}</strong><br><small>Draw: ${new Date(lottery.datetime).toLocaleDateString()} | <strong>Sold: ${soldCount}</strong></small></div><div class="manageable-lottery-item-actions"><button class="btn-icon book" onclick="openAdminBookModal(event, '${id}')" title="Book Ticket"><i class="fas fa-ticket"></i></button><button class="btn-icon" onclick="setupLiveDraw(event, '${id}')" title="Go Live" style="color: var(--secondary-color);"><i class="fas fa-broadcast-tower"></i></button><button class="btn-icon edit" onclick="editLottery(event, '${id}')" title="Edit"><i class="fas fa-edit"></i></button><button class="btn-icon delete" onclick="removeLottery(event, '${id}')" title="Delete"><i class="fas fa-trash"></i></button></div>`;
                    element.appendChild(item);
                });
            };
            renderList(upcoming, upcomingListEl);
            renderList(past, pastListEl);
        };
        
        window.setupLiveDraw = (e, lotteryId) => {
            e.stopPropagation();
            const lottery = allLotteriesCache[lotteryId];
            if (!confirm(`This will reset the current live draw and set up a new one for "${lottery.title}". Are you sure?`)) return;
            const confirmedPurchases = Object.values(allTicketsCache).filter(p => p.lotteryId === lotteryId && p.status === 'confirmed');
            const participantsList = [];
            confirmedPurchases.forEach(p => { p.tickets.forEach(ticketNum => { participantsList.push({ name: p.name, ticket: ticketNum, purchaseId: p.key }); }); });
            if (participantsList.length === 0) { showStatus('No confirmed tickets for this lottery to start a draw.', false); return; }
            shuffleArray(participantsList);
            liveDrawRef.set({ 
                lotteryId: lotteryId, 
                lotteryTitle: lottery.title, 
                status: `Ready to start draw for ${lottery.title}.`, 
                prizes: lottery.prizes || ['Winner'], 
                participants: participantsList, 
                allWinners: [], 
                allLosers: [], 
                currentPick: null, 
                result: null, 
                isAutoDrawing: false, 
                isReset: true, 
                isPicking: false, 
                announcement: null 
            }).then(() => { 
                showStatus(`Live draw for ${lottery.title} is ready!`, true); 
                showPage('live-page'); 
            });
        };

        window.removeLottery = (e, id) => { 
            e.stopPropagation(); 
            if (confirm('Are you sure you want to permanently delete this lottery and all associated ticket data? This action cannot be undone.')) {
                db.ref('lotteries/' + id).remove().then(() => {
                    db.ref('tickets').orderByChild('lotteryId').equalTo(id).once('value', snapshot => {
                        const updates = {};
                        snapshot.forEach(child => { updates[child.key] = null; });
                        db.ref('tickets').update(updates);
                    });
                    showStatus('Lottery deleted successfully.', true);
                }).catch(err => showStatus(err.message, false));
            } 
        };

        window.editLottery = (e, id) => {
            e.stopPropagation();
            const lottery = allLotteriesCache[id];
            document.getElementById('editing-lottery-id').value = id;
            document.getElementById('lottery-title').value = lottery.title;
            document.getElementById('lottery-details').value = lottery.details;
            document.getElementById('existing-image-url').value = lottery.imageUrl;
            const preview = document.getElementById('image-preview');
            preview.src = lottery.imageUrl; 
            preview.style.display = 'block';
            document.getElementById('lottery-ticket-price').value = lottery.price;
            document.getElementById('lottery-datetime').value = lottery.datetime;
            document.getElementById('upload-form-title').textContent = 'Edit Lottery';
            document.getElementById('upload-lottery-submit-btn').textContent = 'Save Changes';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            const prizeContainer = document.getElementById('prize-inputs-container');
            prizeContainer.innerHTML = '<label>Prizes</label>';
            if (lottery.prizes && Array.isArray(lottery.prizes)) {
                lottery.prizes.forEach(prize => addPrizeInput(prize));
            } else {
                addPrizeInput();
            }
            window.scrollTo(0, 0);
        };
        
        // 13. ADMIN: TICKET VIEW & MANAGEMENT
        window.viewAdminLotteryTickets = (lotteryId) => { 
            const lottery = allLotteriesCache[lotteryId];
            const adminTicketView = document.getElementById('admin-lottery-ticket-view');
            adminTicketView.dataset.currentLottery = lotteryId;
            document.getElementById('admin-ticket-lottery-details-container').innerHTML = `<h3>Tickets for: ${lottery.title}</h3>`;
            const tableBody = document.querySelector('#admin-specific-ticket-table tbody');
            tableBody.innerHTML = '';
            Object.values(allTicketsCache).filter(p => p.lotteryId === lotteryId).forEach(p => { p.tickets.forEach(ticketNum => { const row = tableBody.insertRow(); row.innerHTML = `<td>${ticketNum}</td><td>${p.name}</td><td>${p.mobile}</td><td class="status-${p.status}">${p.status}</td><td class="ticket-actions">${p.status === 'pending' ? `<button class="btn-icon btn-icon-accept" title="Accept" onclick="updateTicketStatus('${p.key}', 'confirmed')"><i class="fas fa-check"></i></button><button class="btn-icon btn-icon-reject" title="Reject" onclick="updateTicketStatus('${p.key}', 'rejected')"><i class="fas fa-times"></i></button>` : ''}<button class="btn-icon edit" title="Edit" onclick="editTicket('${p.key}')"><i class="fas fa-edit"></i></button><button class="btn-icon delete" title="Delete" onclick="removeTicket('${p.key}')"><i class="fas fa-trash"></i></button></td>`; }); });
            document.getElementById('admin-lottery-main-view').style.display = 'none';
            adminTicketView.style.display = 'block';
        };
        document.getElementById('back-to-admin-lotteries-btn').addEventListener('click', () => {
            document.getElementById('admin-lottery-main-view').style.display = 'block';
            const adminTicketView = document.getElementById('admin-lottery-ticket-view');
            adminTicketView.style.display = 'none';
            delete adminTicketView.dataset.currentLottery;
        });

        const loadAllTicketsManagementTable = () => {
             const tableBody = document.querySelector('#ticket-management-table tbody'); tableBody.innerHTML = '';
             const purchases = Object.values(allTicketsCache).reverse();
             purchases.forEach(p => {
                 const lotteryTitle = allLotteriesCache[p.lotteryId] ? allLotteriesCache[p.lotteryId].title : 'Unknown Lottery';
                 p.tickets.forEach(ticketNum => {
                     const row = tableBody.insertRow();
                     row.innerHTML = `<td>${ticketNum}</td><td>${p.name}</td><td>${p.mobile}</td><td>${lotteryTitle}</td><td class="status-${p.status}">${p.status}</td><td class="ticket-actions">${p.status === 'pending' ? `<button class="btn-icon btn-icon-accept" title="Accept" onclick="updateTicketStatus('${p.key}', 'confirmed')"><i class="fas fa-check"></i></button><button class="btn-icon btn-icon-reject" title="Reject" onclick="updateTicketStatus('${p.key}', 'rejected')"><i class="fas fa-times"></i></button>` : ''}<button class="btn-icon edit" title="Edit" onclick="editTicket('${p.key}')"><i class="fas fa-edit"></i></button><button class="btn-icon delete" title="Delete" onclick="removeTicket('${p.key}')"><i class="fas fa-trash"></i></button></td>`;
                 });
             });
        };
        window.updateTicketStatus = (id, status) => db.ref(`tickets/${id}/status`).set(status);
        window.removeTicket = (id) => { if (confirm('Delete this ticket purchase record? This cannot be undone.')) db.ref('tickets/' + id).remove(); };
        window.editTicket = (id) => {
            const purchase = allTicketsCache[id];
            document.getElementById('edit-purchase-id').value = id;
            document.getElementById('edit-buyer-name').value = purchase.name;
            document.getElementById('edit-buyer-mobile').value = purchase.mobile;
            document.getElementById('edit-ticket-status').value = purchase.status;
            openModal('edit-ticket-modal');
        };
        document.getElementById('edit-ticket-form').addEventListener('submit', e => {
            e.preventDefault(); const id = document.getElementById('edit-purchase-id').value;
            db.ref('tickets/' + id).update({ name: document.getElementById('edit-buyer-name').value, mobile: document.getElementById('edit-buyer-mobile').value, status: document.getElementById('edit-ticket-status').value, }).then(() => { closeModal(); showStatus('Ticket updated.'); });
        });
        
        window.openAdminBookModal = (e, lotteryId) => {
            e.stopPropagation();
            const lottery = allLotteriesCache[lotteryId]; if (!lottery) return;
            document.getElementById('admin-book-lottery-id').value = lotteryId;
            document.getElementById('admin-book-modal-title').textContent = `Book for: ${lottery.title}`;
            openModal('admin-book-ticket-modal');
        };
        document.getElementById('admin-book-ticket-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const lotteryId = document.getElementById('admin-book-lottery-id').value;
            const quantity = parseInt(document.getElementById('admin-book-ticket-quantity').value, 10);
            const purchaseDetails = { lotteryId: lotteryId, name: document.getElementById('admin-book-buyer-name').value, mobile: document.getElementById('admin-book-buyer-mobile').value, quantity: quantity, tickets: Array.from({ length: quantity }, () => Math.floor(100000 + Math.random() * 900000)), status: 'confirmed', timestamp: new Date().toISOString() };
            db.ref('tickets').push(purchaseDetails).then(() => { closeModal(); showStatus(`${quantity} ticket(s) booked successfully for ${purchaseDetails.name}!`); document.getElementById('admin-book-ticket-form').reset(); }).catch(err => { showStatus(`Error: ${err.message}`, false); });
        });

        // 14. ADMIN REPORTS / BOOK DETAILS LOGIC
        const loadReportsData = () => {
            const listEl = document.getElementById('report-lottery-list'); listEl.innerHTML = '';
            Object.entries(allLotteriesCache).sort((a,b) => new Date(b[1].datetime) - new Date(a[1].datetime)).forEach(([id, lottery]) => {
                let soldTickets = 0; let totalAmount = 0;
                Object.values(allTicketsCache).filter(p => p.lotteryId === id && p.status === 'confirmed').forEach(p => { const ticketCount = p.tickets.length; soldTickets += ticketCount; totalAmount += ticketCount * lottery.price; });
                const item = document.createElement('div'); item.className = 'report-lottery-item'; item.setAttribute('onclick', `viewReportDetails('${id}')`); item.innerHTML = `<strong>${lottery.title}</strong><div class="report-stats"><span>Sold Tickets: <strong>${soldTickets}</strong></span><span class="amount">Total: <strong>‚Çπ${totalAmount.toLocaleString('en-IN')}</strong></span></div>`;
                listEl.appendChild(item);
            });
        };
        window.viewReportDetails = (lotteryId) => {
            const lottery = allLotteriesCache[lotteryId]; if (!lottery) return;
            document.getElementById('report-details-title').textContent = `Sales Details for: ${lottery.title}`;
            const tableBody = document.querySelector('#report-details-table tbody'); tableBody.innerHTML = '';
            Object.values(allTicketsCache).filter(p => p.lotteryId === lotteryId && p.status === 'confirmed').forEach(purchase => { const ticketCount = purchase.tickets.length; const amount = ticketCount * lottery.price; tableBody.innerHTML += `<tr><td>${purchase.name}</td><td>${ticketCount}</td><td>‚Çπ${amount.toLocaleString('en-IN')}</td></tr>`; });
            document.getElementById('report-lottery-list-view').style.display = 'none';
            document.getElementById('report-details-view').style.display = 'block';
        };
        document.getElementById('back-to-reports-list-btn').addEventListener('click', () => {
            document.getElementById('report-lottery-list-view').style.display = 'block';
            document.getElementById('report-details-view').style.display = 'none';
        });

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.getElementById('loading-overlay');
            const enableAudioHandler = () => {
                if (ttsEnabled || !('speechSynthesis' in window)) return;
                ttsEnabled = true; const synth = window.speechSynthesis; synth.speak(new SpeechSynthesisUtterance('')); showStatus('Announcements Enabled');
            };
            document.body.addEventListener('click', enableAudioHandler, { once: true });
            document.body.addEventListener('touchstart', enableAudioHandler, { once: true });
            
            const initialPage = sessionStorage.getItem('loggedInUser') ? 'user-dashboard-page' : 'lottery-page';
            
            const promises = [db.ref('lotteries').once('value'), db.ref('tickets').once('value'), db.ref('lotteryResults').once('value')];
            Promise.all(promises).then(() => {
                processTicketCounts();
                renderAllLotteryLists();
                showPage(initialPage);
                initializeSlotMachine(); 
                addPrizeInput();
                loader.style.opacity = '0';
                setTimeout(() => { loader.style.display = 'none'; }, 500);
            }).catch(error => {
                console.error("Firebase initial data load failed:", error);
                loader.innerHTML = '<p style="color:var(--loss-color); text-align:center; padding: 20px;">Failed to load data.<br>Please check your connection and refresh.</p>';
            });

            const liveSearchInput = document.getElementById('live-result-search');
            const liveSearchResultContainer = document.getElementById('live-search-result-container');

            liveSearchInput.addEventListener('keyup', () => {
                const searchTerm = liveSearchInput.value.trim().toLowerCase();
                
                if (!searchTerm) {
                    liveSearchResultContainer.style.display = 'none';
                    return;
                }

                if (!currentLiveDrawData || (!currentLiveDrawData.allWinners && !currentLiveDrawData.allLosers)) {
                    liveSearchResultContainer.innerHTML = `<p>Draw has not started or no results are available yet.</p>`;
                    liveSearchResultContainer.style.display = 'block';
                    return;
                }

                let foundResult = null;
                let resultHtml = '';
                
                const winners = currentLiveDrawData.allWinners || [];
                foundResult = winners.find(p => 
                    p.ticket.toString().includes(searchTerm) || 
                    p.name.toLowerCase().includes(searchTerm)
                );

                if (foundResult) {
                    resultHtml = `
                        <h4 style="text-align:center;">Result Found!</h4>
                        <p><strong>Ticket:</strong> ${foundResult.ticket}</p>
                        <p><strong>Name:</strong> ${foundResult.name}</p>
                        <p><strong>Result:</strong> <span class="status-win">WINNER!</span></p>
                        <p><strong>Prize:</strong> ${foundResult.prize}</p>
                    `;
                } else {
                    const losers = currentLiveDrawData.allLosers || [];
                    foundResult = losers.find(p => 
                        p.ticket.toString().includes(searchTerm) || 
                        p.name.toLowerCase().includes(searchTerm)
                    );

                    if (foundResult) {
                        resultHtml = `
                            <h4 style="text-align:center;">Result Found!</h4>
                            <p><strong>Ticket:</strong> ${foundResult.ticket}</p>
                            <p><strong>Name:</strong> ${foundResult.name}</p>
                            <p><strong>Result:</strong> <span class="status-loss">Not a winner</span></p>
                        `;
                    }
                }

                if (resultHtml) {
                    liveSearchResultContainer.innerHTML = resultHtml;
                    liveSearchResultContainer.style.display = 'block';
                } else {
                    liveSearchResultContainer.innerHTML = `<p>No ticket matching "${liveSearchInput.value}" found in the results.</p>`;
                    liveSearchResultContainer.style.display = 'block';
                }
            });

        });
    </script>
</body>
</html>
